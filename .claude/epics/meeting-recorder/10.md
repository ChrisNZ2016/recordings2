---
name: Error Handling & Logging
status: open
created: 2025-10-16T03:45:15Z
updated: 2025-10-16T07:39:30Z
github: https://github.com/ChrisNZ2016/recordings2/issues/10
depends_on: [003, 004, 005, 008]
parallel: true
conflicts_with: [003, 004, 005, 008]
---

# Task 009: Error Handling & Logging

## Description

Add comprehensive error handling across all endpoints, implement structured logging for webhook events and errors to improve debugging and reliability.

## Size

M (16-24 hours)

## Dependencies

- **Task 003**: Email Parsing Endpoint (needs to enhance)
- **Task 004**: Bot Creation Endpoint (needs to enhance)
- **Task 005**: Webhook Listener (needs to enhance)
- **Task 008**: AI Summarization Feature (needs to enhance)

## Conflicts

- **Tasks 003, 004, 005, 008**: Modifies the same API files

## Parallel Execution

Yes - can enhance existing code, but coordinate to avoid merge conflicts

## Acceptance Criteria

- [ ] Try-catch blocks in all API routes
- [ ] Appropriate HTTP status codes for errors
- [ ] Structured JSON logging for all webhook events
- [ ] Error responses include meaningful messages
- [ ] Rate limiting on webhook endpoints
- [ ] Validation using Zod schemas
- [ ] Error tracking setup (Vercel logs)

## Technical Details

### Package Installation
```bash
npm install zod @vercel/edge-rate-limit
```

### Error Response Format
Standardize all API errors:
```typescript
interface ErrorResponse {
  error: string;
  message: string;
  status: number;
  timestamp: string;
  path?: string;
  details?: unknown;
}
```

### Logging Structure
Use structured JSON logging:
```typescript
interface LogEntry {
  level: 'info' | 'warn' | 'error';
  timestamp: string;
  endpoint: string;
  event: string;
  data?: unknown;
  error?: {
    message: string;
    stack?: string;
    code?: string;
  };
  metadata?: {
    userId?: string;
    meetingId?: string;
    requestId?: string;
  };
}
```

### Validation Schemas (Zod)

**Email Webhook Schema**:
```typescript
const emailWebhookSchema = z.object({
  envelope: z.object({
    from: z.string().email(),
    to: z.array(z.string().email()),
  }),
  plain: z.string().min(1),
  headers: z.object({
    Subject: z.string(),
  }),
});
```

**Recall.ai Webhook Schema**:
```typescript
const recallWebhookSchema = z.object({
  event: z.enum(['bot.status_change', 'transcript.ready']),
  data: z.object({
    bot_id: z.string().uuid(),
    status: z.string().optional(),
    transcript: z.unknown().optional(),
  }),
});
```

### Rate Limiting
Implement on webhook endpoints:
```typescript
import { Ratelimit } from '@vercel/edge-rate-limit';

const ratelimit = new Ratelimit({
  limit: 100, // requests per window
  interval: '1m',
});
```

### Error Handling Patterns

**API Route Template**:
```typescript
export async function POST(request: Request) {
  const requestId = crypto.randomUUID();

  try {
    // Log incoming request
    logger.info({
      endpoint: '/api/webhook/email',
      event: 'request_received',
      metadata: { requestId },
    });

    // Rate limit check
    const { success } = await ratelimit.limit(request);
    if (!success) {
      return NextResponse.json(
        { error: 'RATE_LIMIT', message: 'Too many requests' },
        { status: 429 }
      );
    }

    // Parse and validate input
    const body = await request.json();
    const validated = emailWebhookSchema.parse(body);

    // Business logic...

    // Log success
    logger.info({
      endpoint: '/api/webhook/email',
      event: 'request_success',
      metadata: { requestId },
    });

    return NextResponse.json({ success: true });

  } catch (error) {
    // Log error
    logger.error({
      endpoint: '/api/webhook/email',
      event: 'request_error',
      error: {
        message: error instanceof Error ? error.message : 'Unknown error',
        stack: error instanceof Error ? error.stack : undefined,
      },
      metadata: { requestId },
    });

    // Return appropriate error response
    if (error instanceof z.ZodError) {
      return NextResponse.json(
        {
          error: 'VALIDATION_ERROR',
          message: 'Invalid request data',
          details: error.errors,
        },
        { status: 400 }
      );
    }

    return NextResponse.json(
      {
        error: 'INTERNAL_ERROR',
        message: 'An unexpected error occurred',
      },
      { status: 500 }
    );
  }
}
```

### HTTP Status Code Guidelines
- **200**: Success
- **201**: Resource created
- **400**: Validation error, bad request
- **401**: Unauthorized (missing/invalid auth)
- **404**: Resource not found
- **409**: Conflict (duplicate resource)
- **429**: Rate limit exceeded
- **500**: Internal server error
- **503**: Service unavailable (external API down)

### Logger Utility
Create `/lib/logger.ts`:
```typescript
export const logger = {
  info: (entry: Omit<LogEntry, 'level'>) => {
    console.log(JSON.stringify({ ...entry, level: 'info' }));
  },
  warn: (entry: Omit<LogEntry, 'level'>) => {
    console.warn(JSON.stringify({ ...entry, level: 'warn' }));
  },
  error: (entry: Omit<LogEntry, 'level'>) => {
    console.error(JSON.stringify({ ...entry, level: 'error' }));
  },
};
```

### Vercel Logs Integration
- Structured JSON logs automatically parsed by Vercel
- Set up log drains if needed for external monitoring
- Use Vercel Analytics for performance tracking

### Endpoints to Enhance
1. `/api/webhook/email` (Task 003)
2. `/api/bots/create` (Task 004)
3. `/api/webhook/recall` (Task 005)
4. `/api/summaries` (Task 008)
5. Any other API routes

## Testing Checklist

- [ ] All API routes have try-catch blocks
- [ ] Validation schemas defined for all inputs
- [ ] Rate limiting works on webhook endpoints
- [ ] Error responses follow standard format
- [ ] Appropriate status codes returned
- [ ] Structured logs visible in Vercel dashboard
- [ ] Test invalid inputs return 400
- [ ] Test rate limit returns 429
- [ ] Test database errors return 500
- [ ] Test external API failures handled gracefully
- [ ] Log entries include all required fields
- [ ] Sensitive data (API keys) not logged
- [ ] Request IDs help trace requests through system

## Notes

- Don't log sensitive data (API keys, full email bodies with PII)
- Consider using Sentry or similar for advanced error tracking
- Rate limits should be tuned based on actual usage patterns
- Zod schemas serve as both validation and documentation
- Future: Add request/response logging middleware
- Future: Implement circuit breaker for external APIs
- Future: Add custom error classes for better error handling
- Consider adding health check endpoint `/api/health`
